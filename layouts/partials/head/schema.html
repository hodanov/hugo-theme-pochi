{{ $logoURL := "" }}
{{ $imageURL := "" }}
{{ $desc := "" }}

{{ with .Site.Params.logo }}
  {{ $logoURL = absURL . }}
{{ end }}

{{ if .IsPage }}
  {{ with .Params.featuredImage }}
    {{ $imageURL = absURL . }}
  {{ end }}
{{ end }}

{{/* Compute description once to safely jsonify later */}}
{{ with .Description }}
  {{ $desc = . }}
{{ else }}
  {{ if .IsPage }}
    {{ $desc = .Summary }}
  {{ else }}
    {{ with .Site.Params.description }}{{ $desc = . }}{{ end }}
  {{ end }}
{{ end }}

{{ if .IsPage }}
  {{ $datePublished := .PublishDate.Local.Format "2006-01-02 15:04:05" }}
  {{ $dateModified := .Lastmod.Local.Format "2006-01-02 15:04:05" }}
  {{ $mainEntity := dict "@type" "WebPage" "@id" .Permalink }}
  {{ $author := dict "@type" "Person" "name" .Site.Params.Author }}
  {{ $logo := dict "@type" "imageObject" "url" $logoURL }}
  {{ $publisher := dict "@type" "Organization" "name" .Site.Params.Author "logo" $logo }}
  {{ $obj := dict
      "@context" "http://schema.org/"
      "@type" "BlogPosting"
      "mainEntityOfPage" $mainEntity
      "headline" .Title
      "image" $imageURL
      "datePublished" $datePublished
      "dateModified" $dateModified
      "description" $desc
      "author" $author
      "publisher" $publisher
  }}
  <script type="application/ld+json">{{ $obj | jsonify | safeJS }}</script>
{{ else }}
  {{ $creator := dict "@type" "Person" "name" .Site.Params.Author }}
  {{ $obj := dict
      "@context" "http://schema.org/"
      "@type" "Blog"
      "name" .Site.Title
      "creator" $creator
      "image" $logoURL
      "url" .Site.BaseURL
      "description" $desc
      "license" "https://creativecommons.org/licenses/by-nc-sa/3.0/us/deed.en_US"
  }}
  <script type="application/ld+json">{{ $obj | jsonify | safeJS }}</script>
{{ end }}
